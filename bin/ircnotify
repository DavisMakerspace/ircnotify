#!/usr/bin/env ruby

require 'cinch'
require 'socket'
require 'json'
require 'etc'

module IRCNotify
  extend self

  VERSION = %x{cd #{File.dirname($0)} && git describe --dirty=-modified}.strip
  @server = nil

  config = ARGV.shift || File.join(File.dirname($0), "..", "etc", "config")
  if not File.exists? config
    puts "Can't find config file #{config}"
    puts "Either create it or specify another config file with: #{File.basename $0} [filename]"
    exit
  end
  load config
  load File.join(File.dirname($0), "..", "share", "config.schema")

  class Client
    def initialize(socket)
      @socket = socket
      @eid = Etc.getpwuid(@socket.getpeereid[0]).name
      @id = @eid
    end
    def start
      IRCNotify.info "New connection #{@socket}"
      @socket.each do |line|
        IRCNotify.debug "Server got: #{line.strip}"
        msg = nil
        if line.start_with? "{"
          begin
            cmd = JSON::parse(line)
          rescue JSON::ParserError => error
            IRCNotify.debug "Could not parse presumed JSON string: #{line}"
            IRCNotify.debug "got error #{error}"
            cmd = {}
          end
          if cmd['id'] then @id = cmd['id'] end
          if cmd['msg'] then msg = cmd['msg'] end
        else
          msg = line.strip
        end
        if msg then IRCNotify.irc_send @id, msg end
      end
      IRCNotify.info "Ending connection #{@socket}"
    end
  end

  def server_loop
    if File.socket?(IRCNotifyConfig::Server::PATH) then File.delete(IRCNotifyConfig::Server::PATH) end
    @server = UNIXServer.new(IRCNotifyConfig::Server::PATH)
    while socket = @server.accept do
      client = IRCNotify::Client.new socket
      Thread.new do
        client.start
      end
    end
  end

  def server_end
    path = @server.path
    @server.shutdown
    @server = nil
    File.delete(path)
  end

  def irc_receive(msg, query)
    msg.reply "ircnotify #{VERSION} listening on #{@server.path}"
  end

  def irc_send(id, msg)
    @bot.channels.each {|channel| channel.send "[#{id}] #{msg}"}
  end

  @bot = Cinch::Bot.new do
    configure do |c|
      c.user = File.basename $0
      c.realname = c.user
      c.nick = IRCNotifyConfig::IRC::NICK
      c.server = IRCNotifyConfig::IRC::SERVER
      c.port = IRCNotifyConfig::IRC::PORT
      c.channels = IRCNotifyConfig::IRC::CHANNELS
    end
    on :connect do
      self.bot.on :channel, /^#{self.bot.nick}(?:[:, ] *(.*)|$)/ do |m, q|
        IRCNotify.irc_receive m, q
      end
      IRCNotify.server_loop
    end
    on :disconnect do
      IRCNotify.server_end
    end
    on :private do |m|
      if m.command == "PRIVMSG" && m.user
        IRCNotify.irc_receive m, m.message
      end
    end
  end

  def start
    @bot.start
  end
  def info(msg)
    @bot.info msg
  end
  def debug(msg)
    @bot.debug msg
  end
end

IRCNotify.start
