#!/usr/bin/env ruby

require 'cinch'
require 'socket'
require 'etc'

module IRCNotify
  extend self

  IRCNOTIFY_VERSION = %x{cd #{File.dirname($0)} && git describe --dirty=-modified}.strip

  config_file = ARGV.shift || File.join(File.dirname($0), "..", "etc", "config")
  if not File.exists? config_file
    puts "Can't find config file #{config_file}"
    puts "Either create it or specify another config file with: #{File.basename $0} [filename]"
    exit
  end
  load config_file

  @bot = Cinch::Bot.new do
    configure do |c|
      c.user = File.basename $0
      c.realname = c.user
      c.nick = IRCNotifyConfig::IRC::NICK
      c.server = IRCNotifyConfig::IRC::SERVER
      c.port = IRCNotifyConfig::IRC::PORT
      c.channels = IRCNotifyConfig::IRC::CHANNELS
    end
    helpers do
      def respond(msg, query)
        msg.reply "ircnotify #{IRCNOTIFY_VERSION} listening on #{@unixserver.path}"
      end
    end
    on :connect do
      self.bot.on :channel, /^#{self.bot.nick}(?:[:, ] *(.*)|$)/ do |m, q|
        respond m, q
      end
      if File.socket?(IRCNotifyConfig::Socket::PATH) then File.delete(IRCNotifyConfig::Socket::PATH) end
      @unixserver = UNIXServer.new(IRCNotifyConfig::Socket::PATH)
      while a = @unixserver.accept do
        Thread.new do
          a.each {|line| self.bot.channels.each {|c| c.send "[#{Etc.getpwuid(a.getpeereid[0]).name}] #{line}" } }
        end
      end
    end
    on :disconnect do
      path = @unixserver.path
      @unixserver.shutdown
      @unixserver = nil
      File.delete(path)
    end
    on :private do |m|
      if m.command == "PRIVMSG" && m.user
        respond m, m.message
      end
    end
  end

  def start
    @bot.start
  end
end

IRCNotify.start
